# üîç –ü–æ—Å—ñ–±–Ω–∏–∫ –∑ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø–æ–º–∏–ª–æ–∫ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó KSeF

## –ü—Ä–æ–±–ª–µ–º–∞: –ü–æ–º–∏–ª–∫–∞ –Ω–∞ —Å—Ç—Ä–æ—Ü—ñ 118 (_wait_for_authentication)

–Ø–∫—â–æ –≤–∏ –±–∞—á–∏—Ç–µ –ø–æ–º–∏–ª–∫—É:
```
API Error checking auth status: {status_code}
```

–¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ —Å–µ—Ä–≤–µ—Ä KSeF –ø–æ–≤–µ—Ä—Ç–∞—î HTTP —Å—Ç–∞—Ç—É—Å **–ù–ï 200**.

---

## üõ†Ô∏è –Ø–∫ –¥—ñ–∞–≥–Ω–æ—Å—Ç—É–≤–∞—Ç–∏ –ø—Ä–æ–±–ª–µ–º—É

### 1. –ó–∞–ø—É—Å—Ç—ñ—Ç—å —Ç–µ—Å—Ç–æ–≤–∏–π —Å–∫—Ä–∏–ø—Ç –∑ –¥–µ—Ç–∞–ª—å–Ω–∏–º –ª–æ–≥—É–≤–∞–Ω–Ω—è–º:

```bash
cd /home/user/einvoice_pl/ksef2
python3 test_auth.py
```

–¶–µ–π —Å–∫—Ä–∏–ø—Ç –ø–æ–∫–∞–∂–µ **–¥–µ—Ç–∞–ª—å–Ω—ñ –ª–æ–≥–∏** –∫–æ–∂–Ω–æ–≥–æ –∫—Ä–æ–∫—É –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó.

---

## üîé –ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏ –ø–æ–º–∏–ª–æ–∫

### **HTTP 400 (Bad Request) - –ü–æ–º–∏–ª–∫–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó**

**–©–æ —Ü–µ –æ–∑–Ω–∞—á–∞—î:**
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç `reference_number`
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø–∏—Ç—É
- Challenge –≤–∂–µ –∑–∞—Å—Ç–∞—Ä—ñ–≤

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏:**
```python
# –£ –ª–æ–≥–∞—Ö –∑–Ω–∞–π–¥—ñ—Ç—å —Ä—è–¥–æ–∫:
_logger.info(f'Reference number: {self.reference_number}')
```

**–ú–∞—î –±—É—Ç–∏ —Ñ–æ—Ä–º–∞—Ç:** `20251212-CR-ABC123DEF456-789`

**–†—ñ—à–µ–Ω–Ω—è:**
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç—Ä–∏–º–∞–Ω–∏–π `referenceNumber` –∑ –∫—Ä–æ–∫—É 4
- –ú–æ–∂–ª–∏–≤–æ, –ø–æ—Ç—Ä—ñ–±–µ–Ω –Ω–æ–≤–∏–π challenge (–∑—Ä–æ–±—ñ—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—É –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é)

---

### **HTTP 401 (Unauthorized) - –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ**

**–©–æ —Ü–µ –æ–∑–Ω–∞—á–∞—î:**
- –¢–∏–º—á–∞—Å–æ–≤–∏–π `auth_token` –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π
- –¢–æ–∫–µ–Ω –∑–∞—Å—Ç–∞—Ä—ñ–≤ (challenge timeout)
- –¢–æ–∫–µ–Ω –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î reference_number

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏:**
```python
# –£ –ª–æ–≥–∞—Ö –∑–Ω–∞–π–¥—ñ—Ç—å —Ä—è–¥–æ–∫:
_logger.info(f'Auth token (first 30 chars): {self.auth_token[:30]}...')
```

**–ú–∞—î –±—É—Ç–∏ –¥–æ–≤–≥–∏–π —Ç–æ–∫–µ–Ω** (100+ —Å–∏–º–≤–æ–ª—ñ–≤)

**–†—ñ—à–µ–Ω–Ω—è:**
1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç—Ä–∏–º–∞–Ω–∏–π `authenticationToken.token` –∑ –∫—Ä–æ–∫—É 4
2. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Å–∞–º–µ **auth_token**, –∞ –Ω–µ —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π token
3. –ù–µ —á–µ–∫–∞–π—Ç–µ –∑–∞–Ω–∞–¥—Ç–æ –¥–æ–≤–≥–æ –º—ñ–∂ –∫—Ä–æ–∫–∞–º–∏ 4 —ñ 5 (challenge –º–æ–∂–µ –∑–∞—Å—Ç–∞—Ä—ñ—Ç–∏)

---

### **HTTP 404 (Not Found) - –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ**

**–©–æ —Ü–µ –æ–∑–Ω–∞—á–∞—î:**
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π URL endpoint
- Reference number –Ω–µ —ñ—Å–Ω—É—î

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏:**
```python
# –£ –ª–æ–≥–∞—Ö –∑–Ω–∞–π–¥—ñ—Ç—å —Ä—è–¥–æ–∫:
_logger.info(f'URL: {config.api_url}/api/v2/auth/{self.reference_number}')
```

**–ú–∞—î –±—É—Ç–∏:**
- Test: `https://ksef-test.mf.gov.pl/api/v2/auth/{reference_number}`
- Prod: `https://ksef.mf.gov.pl/api/v2/auth/{reference_number}`

**–†—ñ—à–µ–Ω–Ω—è:**
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ `config.api_url`
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ—Å—Ç—å `reference_number`

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–∞ –∫—Ä–æ—Ü—ñ 4

```json
{
  "authenticationToken": {
    "token": "–î–û–í–ì–ò–ô-–¢–û–ö–ï–ù-100+-–°–ò–ú–í–û–õ–Ü–í...",
    "type": "internal"
  },
  "referenceNumber": "20251212-CR-ABC123DEF456-789",
  "timestamp": "2025-12-12T10:30:00.000Z"
}
```

**–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤ –ª–æ–≥–∞—Ö:**
```
Step 4 - Response from /auth/ksef-token: {...}
```

–Ø–∫—â–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —ñ–Ω—à–∞ - —î –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞ –∫—Ä–æ—Ü—ñ 4 (—ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó).

---

## üîß –ü–æ–∫—Ä–æ–∫–æ–≤–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ö—Ä–æ–∫ 1: –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ Challenge
```python
# –£ –ª–æ–≥–∞—Ö –º–∞—î –±—É—Ç–∏:
# API call to: POST /api/v2/auth/challenge
# Response: {"challenge": "...", "timestamp": "..."}
```

### –ö—Ä–æ–∫ 2: –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —Ç–æ–∫–µ–Ω–∞
```python
# –ú–∞—î –±—É—Ç–∏:
# Token to encrypt: {kseftoken}|{timestamp_milliseconds}
```

### –ö—Ä–æ–∫ 3: –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ NIP
```python
# –£ –ª–æ–≥–∞—Ö –±—É–¥–µ:
# contextIdentifier: {"type": "NIP", "value": "9462527947"}
```

–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ NIP –≤–∏—Ç—è–≥–Ω—É—Ç–∏–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑ `config.kseftoken`.

### –ö—Ä–æ–∫ 4: –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
```python
# –£ –ª–æ–≥–∞—Ö:
# Step 4 - Response from /auth/ksef-token: {full_response}
```

–Ø–∫—â–æ –∑–∞–º—ñ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞ —î –ø–æ–º–∏–ª–∫–∞ - –ø—Ä–æ–±–ª–µ–º–∞ —É —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—ñ –∞–±–æ –≤ —Å–∞–º–æ–º—É KSeF —Ç–æ–∫–µ–Ω—ñ.

### –ö—Ä–æ–∫ 5: –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ polling
```python
# –£ –ª–æ–≥–∞—Ö:
# Starting authentication polling...
# Reference number: 20251212-CR-...
# Auth token (first 30 chars): ABC123...
# URL: https://ksef-test.mf.gov.pl/api/v2/auth/20251212-CR-...
```

---

## üÜò –©–æ —Ä–æ–±–∏—Ç–∏, —è–∫—â–æ –Ω—ñ—á–æ–≥–æ –Ω–µ –¥–æ–ø–æ–º–∞–≥–∞—î

1. **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ KSeF —Ç–æ–∫–µ–Ω:**
   ```python
   # –£ config.py:
   kseftoken = "20251209-EC-1B9E01E000-7E37CF99BC-E2|nip-9462527947|..."
   ```
   - –¢–æ–∫–µ–Ω –º–∞—î –±—É—Ç–∏ –∞–∫—Ç—É–∞–ª—å–Ω–∏–º (–Ω–µ –∑–∞—Å—Ç–∞—Ä—ñ–ª–∏–º)
   - –§–æ—Ä–º–∞—Ç: `{date}-{type}-{id}-{hash}|nip-{nip}|{signature}`

2. **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç:**
   - –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç KsefTokenEncryption –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è
   - –£ –ª–æ–≥–∞—Ö –º–∞—î –±—É—Ç–∏: `–í–∏–±–∏—Ä–∞—î–º–æ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç KsefTokenEncryption`

3. **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –º–µ—Ä–µ–∂—É:**
   ```bash
   curl -X POST https://ksef-test.mf.gov.pl/api/v2/auth/challenge
   ```
   –ú–∞—î –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ JSON –∑ challenge.

4. **–ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó API:**
   - https://www.gov.pl/web/kas/ksef-api

---

## üìù –ü—Ä–∏–∫–ª–∞–¥ —É—Å–ø—ñ—à–Ω–æ–≥–æ –≤–∏–≤–æ–¥—É

```
2025-12-12 10:30:00 - auth - INFO - Step 4 - Response from /auth/ksef-token: {...}
2025-12-12 10:30:00 - auth - INFO - Authentication initiated, reference: 20251212-CR-ABC...
2025-12-12 10:30:00 - auth - INFO - Temporary auth_token: ABC123DEF456...
2025-12-12 10:30:00 - auth - INFO - Starting authentication polling...
2025-12-12 10:30:02 - auth - INFO - Auth status check #1: code=100, desc=Processing
2025-12-12 10:30:04 - auth - INFO - Auth status check #2: code=200, desc=Authorized
2025-12-12 10:30:04 - auth - INFO - Authentication confirmed! ‚úì
2025-12-12 10:30:04 - auth - INFO - Step 6 - Response from /auth/token/redeem: {...}
2025-12-12 10:30:04 - auth - INFO - Final session token obtained: XYZ789...
```
